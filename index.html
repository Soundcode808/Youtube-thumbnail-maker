<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* --- [1] ê¸°ë³¸ ì„¤ì • --- */
      body { 
        font-family: 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; 
        background: #121212; 
        display: flex; flex-direction: column; align-items: center; padding: 20px; color: #e0e0e0;
        user-select: none; 
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
        height: 100vh;
        box-sizing: border-box;
        overflow: hidden; 
      }
      
      /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
      * { -ms-overflow-style: none; scrollbar-width: none; }
      *::-webkit-scrollbar { display: none; }
      
      input, textarea, select { user-select: text; -webkit-user-select: text; }
      .hidden-file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; opacity: 0; z-index: -1; }

      .container { 
          background: #1e1e1e; 
          padding: 20px; 
          border-radius: 12px; 
          box-shadow: 0 15px 40px rgba(0,0,0,0.7); 
          max-width: 1200px; 
          width: 100%; 
          height: calc(100vh - 40px);
          display: grid; 
          grid-template-rows: auto 1fr; 
          gap: 15px; 
          box-sizing: border-box;
      }

      .header-area { text-align: center; flex-shrink: 0; }
      h2 { margin-bottom: 5px; color: #fff; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; margin-top: 0; }
      h2 i { color: #ff0000; margin-right: 10px; }

      /* --- [2] ë ˆì´ì•„ì›ƒ --- */
      .workspace {
          display: grid;
          grid-template-columns: 360px 1fr; 
          gap: 25px;
          height: 100%;
          overflow: hidden; 
          min-height: 0;
      }

      .control-panel { overflow-y: auto; padding-right: 5px; height: 100%; padding-bottom: 50px; }

      .right-panel-wrapper {
          display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative;
          background: #181818; border-radius: 12px; border: 1px solid #333;
      }

      .quick-menu {
          display: flex; gap: 10px; width: 100%; justify-content: space-between;
          flex-shrink: 0; z-index: 10; background: #252525; padding: 10px; box-sizing: border-box; border-bottom: 1px solid #333;
      }
      .quick-btn {
          flex: 1; background: #2a2a2a; color: #aaa; border: 1px solid #444; padding: 8px; border-radius: 6px;
          cursor: pointer; font-size: 13px; font-weight: 600; text-align: center; transition: all 0.2s;
          display: flex; flex-direction: column; align-items: center; gap: 4px;
      }
      .quick-btn:hover { background: #333; color: #fff; }
      .quick-btn.active { background: #3ea6ff; color: #000; border-color: #3ea6ff; }

      .canvas-scroll-area { 
          flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box; position: relative;
      }
      
      #canvas-wrapper { 
          width: 100%; max-width: 900px; aspect-ratio: 16/9; max-height: 60vh; 
          border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 1px solid #444; background: #000; 
          margin: auto; margin-bottom: 15px; 
          display: flex; justify-content: center; align-items: center; position: relative; cursor: crosshair; touch-action: none; flex-shrink: 0;
      }
      .canvas-actions { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; padding-bottom: 20px; }
      
      @supports not (aspect-ratio: 16/9) { #canvas-wrapper { height: 0; padding-bottom: 56.25%; } }
      canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

      /* --- [3] UI ìŠ¤íƒ€ì¼ --- */
      .section { background: #2a2a2a; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; transition: all 0.3s ease; }
      .section-header { padding: 15px; background: #333; cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; }
      .section-header:hover { background: #3a3a3a; }
      .section-title { font-size: 14px; font-weight: 700; color: #f0f0f0; display: flex; align-items: center; gap: 8px; }
      .section.collapsed .section-content { display: none; }
      .section.collapsed .section-toggle-icon { transform: rotate(-90deg); }
      .section-toggle-icon { transition: transform 0.3s; color: #888; }
      .section-content { padding: 15px; border-top: 1px solid #333; }
      
      label { display: block; font-size: 11px; margin-bottom: 4px; color: #aaa; font-weight: 600; }
      input[type="text"], input[type="number"], select { width: 100%; padding: 10px; background: #121212; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }
      input[type="range"] { width: 100%; cursor: pointer; accent-color: #3ea6ff; margin-bottom: 8px; height: 4px; background: #444; border-radius: 2px; }

      .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 14px; box-sizing: border-box; }
      .btn-primary { background: #3ea6ff; color: #000; margin-bottom: 10px; }
      .btn-secondary { background: #555; color: #fff; margin-bottom: 5px; font-size: 12px; padding: 10px; }
      .btn-success { background: #2ba640; color: white; font-size: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(43, 166, 64, 0.3); }
      .btn-upload { background: #333; color: #ccc; border: 1px solid #444; }
      .btn-dist { background: #FFD700; color: #000; margin-top:10px; }
      .btn-small { width: auto; padding: 6px 12px; margin-bottom: 0; margin-left: 5px; font-size: 11px; }
      
      .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding: 4px 0; }
      .toggle-label { font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 6px; }
      input[type="checkbox"] { width: 18px; height: 18px; accent-color: #3ea6ff; cursor: pointer; }

      .color-palette { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
      .color-swatch { width: 24px; height: 24px; border-radius: 4px; cursor: pointer; border: 1px solid #555; transition: transform 0.1s; }
      .color-swatch:hover { transform: scale(1.1); border-color: #fff; }
      .custom-palette-area { margin-top: 5px; border-top: 1px dashed #444; padding-top: 5px; }
      .custom-label span { font-size: 10px; color: #888; }
      .color-input-wrapper { display: flex; align-items: center; gap: 5px; background: #181818; padding: 6px 10px; border-radius: 4px; border: 1px solid #444; margin-bottom: 8px; }
      input[type="color"] { width: 30px; height: 30px; border: none; background: none; cursor: pointer; padding: 0; flex-shrink: 0; }

      .text-layer { background: #333; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #3ea6ff; position: relative; }
      .remove-btn { position: absolute; top: 8px; right: 8px; background: none; border: none; color: #ff5252; cursor: pointer; font-size: 14px; padding: 5px; }
      .style-group { display: flex; gap: 5px; margin-bottom: 8px; }
      .style-btn { flex: 1; background: #444; border: 1px solid #555; color: #aaa; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
      .style-btn.active { background: #3ea6ff; color: #000; border-color: #3ea6ff; font-weight: bold; }
      
      .preset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
      .preset-btn { background: #3a3a3a; color: #e0e0e0; font-size: 12px; padding: 12px 5px; border-radius: 6px; border: 1px solid #444; cursor: pointer; text-align: center; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; }

      .font-manager { background: #222; padding: 12px; border-radius: 6px; border: 1px dashed #555; margin-bottom: 15px; }
      .donation-area { margin-top: 30px; text-align: center; border-top: 1px dashed #444; padding-top: 20px; width: 100%; }
      .qr-wrapper { display: inline-block; padding: 10px; background: #fff; border-radius: 12px; border: 4px solid #FFD700; }
      .qr-img { width: 250px; height: auto; display: block; }
      #owner-tools { margin-top: 30px; padding: 15px; background: #333; border: 2px dashed #FFD700; border-radius: 8px; text-align: center; }

      .bg-control-panel { margin-top: 15px; background: #222; padding: 12px; border-radius: 6px; border: 1px solid #444; display: none; }
      .bg-control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .mini-input-group { display: flex; align-items: center; gap: 5px; }
      
      .scale-slider-container { margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; border: 1px solid #333; display: none; }
      .sub-option-box { background: #252525; padding: 10px; border-radius: 6px; margin-top: 5px; border-left: 2px solid #555; font-size: 12px; }

      @media (max-width: 900px) {
        body { height: auto; overflow: auto; }
        .container { display: flex; flex-direction: column; height: auto; }
        .workspace { display: flex; flex-direction: column; height: auto; overflow: visible; }
        .control-panel { height: auto; padding-right: 0; }
        .right-panel-wrapper { height: auto; overflow: visible; border: none; background: transparent; }
        .canvas-scroll-area { overflow: visible; height: auto; padding: 0; }
        .right-panel-wrapper { order: 1; margin-bottom: 10px; }
        .control-panel { order: 2; }
        .quick-menu { position: sticky; top: 0; z-index: 100; padding: 10px 0; margin-bottom: 0; background: #121212; border: none; }
        #canvas-wrapper { max-height: none; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-area">
          <h2 style="margin-bottom: 0px; font-size: 32px;"><i class="fab fa-youtube"></i> ë”¸ê¹ ìœ íŠœë¸Œ ì¸ë„¤ì¼ ë©”ì´ì»¤ V17 (Color Palette+)</h2>
          <div style="text-align: center; margin-bottom: 5px; margin-top: 5px; color: #FFD700; font-size: 18px; font-weight: bold; letter-spacing: 1px; opacity: 0.9;">
              [ ë¬´ë‹¨ ìˆ˜ì •, ë³µì œ, ì¬ë°°í¬ ê¸ˆì§€ ]
          </div>
      </div>

      <div class="workspace">
        <!-- ì™¼ìª½: ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel" id="mainControlPanel">
            
            <div class="section" id="section-bg">
            <div class="section-header" onclick="toggleSection('section-bg')">
                <div class="section-title"><i class="fas fa-image"></i> ë°°ê²½ & ì•ˆì „ ì˜ì—­</div>
                <i class="fas fa-chevron-down section-toggle-icon"></i>
            </div>
            <div class="section-content">
                <input type="file" id="imageLoader" accept="image/*" class="hidden-file-input" onchange="handleImageUpload(this)">
                <label for="imageLoader" class="btn btn-upload">
                    <i class="fas fa-folder-open"></i> ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                </label>
                <div id="bgControlPanel" class="bg-control-panel">
                    <div class="toggle-row" style="margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #444;">
                        <span class="toggle-label" style="color:#FFD700; font-weight:bold;"><i class="fas fa-lock"></i> ì´ë¯¸ì§€ ì ê¸ˆ (Lock)</span>
                        <input type="checkbox" id="bgLock" onchange="updateBgLock()" checked>
                    </div>
                    <label>í¬ê¸° ì¡°ì ˆ (Width / Height)</label>
                    <div class="bg-control-grid">
                        <div class="mini-input-group"><span style="font-size:11px; color:#888;">W</span><input type="number" id="bgWidth" oninput="updateBgSize('w')"></div>
                        <div class="mini-input-group"><span style="font-size:11px; color:#888;">H</span><input type="number" id="bgHeight" oninput="updateBgSize('h')"></div>
                    </div>
                    <div class="toggle-row" style="margin-top:5px;">
                        <span class="toggle-label">ë¹„ìœ¨ ê³ ì • (Aspect Ratio)</span>
                        <input type="checkbox" id="bgRatio" checked onchange="toggleScaleSlider()">
                    </div>
                    <div id="scaleSliderArea" class="scale-slider-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="margin:0; color:#3ea6ff;">ğŸš€ ì „ì²´ í¬ê¸° ì¡°ì ˆ (Zoom)</label>
                            <span id="scaleValue" style="font-size:11px; color:#aaa;">100%</span>
                        </div>
                        <input type="range" id="bgScaleSlider" min="10" max="300" value="100" oninput="updateBgScale(this.value)">
                    </div>

                    <label style="margin-top:10px;">ìœ„ì¹˜ ì´ë™ (X / Y)</label>
                    <div class="bg-control-grid">
                        <div class="mini-input-group"><span style="font-size:11px; color:#888;">X</span><input type="number" id="bgX" oninput="updateBgPos('input')"></div>
                        <div class="mini-input-group"><span style="font-size:11px; color:#888;">Y</span><input type="number" id="bgY" oninput="updateBgPos('input')"></div>
                    </div>
                    <!-- ëª¨ë°”ì¼ìš© ìœ„ì¹˜ ì¡°ì ˆ ê²Œì´ì§€ -->
                    <div style="margin-top:5px; padding:8px; background:#181818; border-radius:6px; border:1px solid #333;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                            <span style="font-size:11px; color:#aaa; width:15px; font-weight:bold;">â†”</span>
                            <input type="range" id="bgXSlider" min="-1500" max="1500" value="0" oninput="updateBgPos('slider')">
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:11px; color:#aaa; width:15px; font-weight:bold;">â†•</span>
                            <input type="range" id="bgYSlider" min="-1000" max="1000" value="0" oninput="updateBgPos('slider')">
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="resetBgImage()" style="margin-top:10px; background:#444; border-color:#555;">
                        <i class="fas fa-undo-alt"></i> ì´ë¯¸ì§€ í¬ê¸°/ìœ„ì¹˜ ì´ˆê¸°í™”
                    </button>

                </div>
                <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
                    <div class="toggle-row"><span class="toggle-label"><i class="fas fa-eye"></i> ì‹œê°„ í‘œì‹œ (Safe Zone)</span><input type="checkbox" id="checkSafeZone" onchange="drawCanvas()" checked></div>
                    <div class="toggle-row" style="margin-left: 10px;"><span class="toggle-label"><i class="fas fa-music"></i> ìŒí‘œ ì•„ì´ì½˜ (ë®¤ì§ë¹„ë””ì˜¤)</span><input type="checkbox" id="checkMusicIcon" onchange="drawCanvas()"></div>
                    <div class="toggle-row" style="margin-top: 10px;"><span class="toggle-label"><i class="fas fa-border-all"></i> 3ë¶„í•  ê·¸ë¦¬ë“œ (ìì„)</span><input type="checkbox" id="checkGrid3" onchange="toggleGrid(3)"></div>
                    <div class="toggle-row"><span class="toggle-label"><i class="fas fa-th"></i> 6ë¶„í•  ê·¸ë¦¬ë“œ (ìì„)</span><input type="checkbox" id="checkGrid6" onchange="toggleGrid(6)"></div>
                </div>
            </div>
            </div>

            <div class="section collapsed" id="section-layout">
                <div class="section-header" onclick="toggleSection('section-layout')">
                    <div class="section-title"><i class="fas fa-chart-line"></i> í´ë¦­ ë¶€ë¥´ëŠ” 6ê°€ì§€ ë°°ì¹˜</div>
                    <i class="fas fa-chevron-down section-toggle-icon"></i>
                </div>
                <div class="section-content">
                    <div class="preset-grid">
                        <div class="preset-btn" onclick="applyPreset('center-big')"><i class="fas fa-bullseye"></i> ì¤‘ì•™ ì´ˆëŒ€í˜•</div>
                        <div class="preset-btn" onclick="applyPreset('left-hook')"><i class="fas fa-align-left"></i> ì¢Œì¸¡ í›…(Hook)</div>
                        <div class="preset-btn" onclick="applyPreset('split-contrast')"><i class="fas fa-columns"></i> ì¢Œìš° ë¶„í• </div>
                        <div class="preset-btn" onclick="applyPreset('bottom-story')"><i class="fas fa-quote-left"></i> í•˜ë‹¨ ìë§‰í˜•</div>
                        <div class="preset-btn" onclick="applyPreset('corner-badge')"><i class="fas fa-certificate"></i> ì¢Œìƒë‹¨ ë±ƒì§€</div>
                        <div class="preset-btn" onclick="applyPreset('diagonal-dynamic')"><i class="fas fa-slash"></i> ëŒ€ê°ì„  ë°°ì¹˜</div>
                    </div>
                </div>
            </div>

            <div class="section collapsed" id="section-effect">
            <div class="section-header" onclick="toggleSection('section-effect')">
                <div class="section-title"><i class="fas fa-wand-magic-sparkles"></i> ë””ìì¸ íš¨ê³¼</div>
                <i class="fas fa-chevron-down section-toggle-icon"></i>
            </div>
            <div class="section-content">
                <div class="toggle-row"><span class="toggle-label">ğŸ¬ ì‹œë„¤ë§ˆí‹± ê·¸ë¦¼ì (í•˜ë‹¨)</span><input type="checkbox" id="checkGradient" onchange="drawCanvas()" checked></div>
                <input type="range" id="gradIntensity" min="0" max="100" value="70" oninput="drawCanvas()">
                <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">
                <div class="toggle-row"><span class="toggle-label">ğŸ–¼ï¸ ì¸ë„¤ì¼ í…Œë‘ë¦¬</span><input type="checkbox" id="checkBorder" onchange="drawCanvas()"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div><label>ë‘ê»˜</label><input type="number" id="borderWidth" value="15" oninput="drawCanvas()"></div>
                    <div><label>ë¼ìš´ë”©</label><input type="number" id="borderRadius" value="30" oninput="drawCanvas()"></div>
                </div>
                <label style="margin-top:5px;">í…Œë‘ë¦¬ ìƒ‰ìƒ</label>
                <div class="color-palette" id="borderPalette"></div>
                <div class="color-input-wrapper"><input type="color" id="borderColor" value="#FFD700" oninput="drawCanvas()"></div>
            </div>
            </div>

            <div class="section" id="section-text">
            <div class="section-header" onclick="toggleSection('section-text')">
                <div class="section-title"><i class="fas fa-font"></i> í…ìŠ¤íŠ¸ í¸ì§‘</div>
                <i class="fas fa-chevron-down section-toggle-icon"></i>
            </div>
            <div class="section-content">
                <div class="font-manager">
                    <label style="color:#3ea6ff; margin-bottom:8px;"><i class="fas fa-upload"></i> ë‚´ ì»´í“¨í„° í°íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</label>
                    <input type="file" id="fontFileInput" class="hidden-file-input" onchange="handleFontUpload(this)">
                    <label for="fontFileInput" class="btn btn-secondary"><i class="fas fa-file-import"></i> í°íŠ¸ íŒŒì¼ ì„ íƒ (.ttf/.otf)</label>
                    <div style="margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                        <label>ë˜ëŠ” ì„¤ì¹˜ëœ í°íŠ¸ ì´ë¦„ ì§ì ‘ ì…ë ¥</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="manualFontInput" placeholder="ì˜ˆ: NanumGothic" style="margin-bottom:0;">
                            <button class="btn btn-secondary" style="width:50px; margin-bottom:0;" onclick="addManualFont()">ì¶”ê°€</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTextLayer()"><i class="fas fa-plus"></i> í…ìŠ¤íŠ¸ ì¶”ê°€í•˜ê¸°</button>
                <div id="textLayersContainer"></div>
            </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìº”ë²„ìŠ¤ ë° ë©”ë‰´ ì˜ì—­ -->
        <div class="right-panel-wrapper">
            <div class="quick-menu">
                <div class="quick-btn active" onclick="jumpToSection('section-bg', this)"><i class="fas fa-image"></i> ë°°ê²½</div>
                <div class="quick-btn" onclick="jumpToSection('section-layout', this)"><i class="fas fa-th-large"></i> ë°°ì¹˜</div>
                <div class="quick-btn" onclick="jumpToSection('section-effect', this)"><i class="fas fa-magic"></i> íš¨ê³¼</div>
                <div class="quick-btn" onclick="jumpToSection('section-text', this)"><i class="fas fa-font"></i> í…ìŠ¤íŠ¸</div>
            </div>

            <div class="canvas-scroll-area">
                <div id="canvas-wrapper">
                    <canvas id="mainCanvas"></canvas>
                </div>
                
                <div class="canvas-actions">
                    <div style="display: flex; gap: 15px; width: 100%; justify-content: space-between; font-size: 12px; color: #888;">
                        <span><i class="fas fa-mouse-pointer"></i> <b>Tip:</b> ë“œë˜ê·¸ ì‹œ ê·¸ë¦¬ë“œì— ìì„ì²˜ëŸ¼ ë¶™ìŠµë‹ˆë‹¤.</span>
                        <span><i class="fas fa-file-image"></i> 1280x720 (Max 2MB)</span>
                    </div>

                    <button class="btn btn-success" id="saveBtn" onclick="downloadImage()">
                        <i class="fas fa-download"></i> ì¸ë„¤ì¼ ì €ì¥í•˜ê¸° (ìë™ ìµœì í™”)
                    </button>

                    <div class="donation-area">
                        <h4><i class="fas fa-coffee"></i> [ê°œë°œìì—ê²Œ ì»¤í”¼ ì˜ê¸°]</h4>
                        <div class="donation-link">
                            <div class="qr-wrapper" id="qrWrapper" style="display:none;"><img src="" alt="ì¹´ì¹´ì˜¤í˜ì´ QR" class="qr-img"></div>
                            <div id="qr-error"><i class="fas fa-exclamation-circle"></i> ì•„ë˜ 'ë°°í¬ìš© íŒŒì¼ ë§Œë“¤ê¸°'ì—ì„œ<br>QR ì½”ë“œë¥¼ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                        </div>
                    </div>

                    <div id="owner-tools">
                        <h3><i class="fas fa-crown"></i> ğŸ‘‘ ë°°í¬ìš© íŒŒì¼ ë§Œë“¤ê¸° (ì£¼ì¸ì¥ ì „ìš©)</h3>
                        <p>ì—¬ê¸°ì„œ QR ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ì €ì¥í•˜ë©´,<br>ì´ë¯¸ì§€ê°€ <b>ë‚´ì¥ëœ ë‹¨ì¼ HTML íŒŒì¼</b>ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
                        <input type="file" id="qrUploadInput" accept="image/*" class="hidden-file-input" onchange="makeSingleFile(this)">
                        <label for="qrUploadInput" class="btn btn-dist"><i class="fas fa-file-export"></i> QRì½”ë“œ ë„£ê³  ë°°í¬ íŒŒì¼ ì €ì¥í•˜ê¸°</label>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById('mainCanvas');
      const ctx = canvas.getContext('2d');
      
      let bgLayer = { img: null, x: 0, y: 0, w: 0, h: 0, locked: true, aspectRatio: 1 };
      let isDragging = false, dragTarget = null, dragIndex = -1, startX, startY, startBgX, startBgY, activeGrid = 0, textLayers = [];
      const colorPresets = ['#FFFFFF', '#000000', '#FF0000', '#FFD700', '#00FF00', '#00FFFF', '#FF00FF', '#FF5722', '#2196F3', '#9C27B0', '#F48FB1', '#FFF59D'];
      let customColors = ['#333333', '#555555', '#777777', '#999999', '#AAAAAA'];
      let availableFonts = [
        { name: 'Impact', value: 'Impact' }, { name: 'ê³ ë”• (ê¸°ë³¸)', value: 'sans-serif' }, { name: 'ëª…ì¡° (ì§„ì§€)', value: 'serif' },
        { name: 'Verdana (ê¹”ë”)', value: 'Verdana' }, { name: 'Comic Sans (ì†ê¸€ì”¨)', value: 'Comic Sans MS' }, { name: 'Arial Black', value: 'Arial Black' },
      ];

      canvas.width = 1280; canvas.height = 720;
      
      function init() {
        createPaletteUI('borderPalette', 'borderColor');
        drawCanvas();
        renderTextLayersUI();
        setupCanvasEvents();
      }

      function toggleSection(id) { document.getElementById(id).classList.toggle('collapsed'); }
      function jumpToSection(id, btnElement) {
          document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
          btnElement.classList.add('active');
          const section = document.getElementById(id);
          section.classList.remove('collapsed');
          const panel = document.getElementById('mainControlPanel');
          if(window.innerWidth <= 900) { section.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
          else { panel.scrollTo({ top: section.offsetTop - panel.offsetTop, behavior: 'smooth' }); }
      }

      function handleImageUpload(input) {
        const reader = new FileReader();
        reader.onload = function(event){
            const img = new Image();
            img.onload = function(){
                resetBgLogic(img); 
            }
            img.src = event.target.result;
        }
        if(input.files[0]) reader.readAsDataURL(input.files[0]);
        input.value = null; 
      }

      function resetBgLogic(img) {
          const hRatio = canvas.width / img.width;
          const vRatio = canvas.height / img.height;
          const ratio = Math.max(hRatio, vRatio); 
          bgLayer.img = img; bgLayer.aspectRatio = img.width / img.height;
          bgLayer.w = img.width * ratio; bgLayer.h = img.height * ratio;
          bgLayer.x = (canvas.width - bgLayer.w) / 2; bgLayer.y = (canvas.height - bgLayer.h) / 2;
          bgLayer.locked = true; 
          document.getElementById('bgControlPanel').style.display = 'block';
          updateBgUI(); toggleScaleSlider(); drawCanvas();
      }

      function resetBgImage() {
          if(!bgLayer.img) return;
          resetBgLogic(bgLayer.img);
      }

      function updateBgUI() {
          document.getElementById('bgWidth').value = Math.round(bgLayer.w);
          document.getElementById('bgHeight').value = Math.round(bgLayer.h);
          document.getElementById('bgX').value = Math.round(bgLayer.x);
          document.getElementById('bgY').value = Math.round(bgLayer.y);
          document.getElementById('bgXSlider').value = Math.round(bgLayer.x);
          document.getElementById('bgYSlider').value = Math.round(bgLayer.y);
          document.getElementById('bgLock').checked = bgLayer.locked;
          const currentPercent = Math.round((bgLayer.w / canvas.width) * 100);
          document.getElementById('bgScaleSlider').value = currentPercent;
          document.getElementById('scaleValue').innerText = currentPercent + '%';
      }

      window.updateBgSize = function(type) {
          if(!bgLayer.img) return;
          const keepRatio = document.getElementById('bgRatio').checked;
          if(type === 'w') { bgLayer.w = parseFloat(document.getElementById('bgWidth').value); if(keepRatio) bgLayer.h = bgLayer.w / bgLayer.aspectRatio; } 
          else { bgLayer.h = parseFloat(document.getElementById('bgHeight').value); if(keepRatio) bgLayer.w = bgLayer.h * bgLayer.aspectRatio; }
          updateBgUI(); drawCanvas();
      }
      window.updateBgScale = function(val) {
          if(!bgLayer.img) return;
          const percent = parseInt(val);
          bgLayer.w = (canvas.width * percent) / 100; bgLayer.h = bgLayer.w / bgLayer.aspectRatio;
          updateBgUI(); drawCanvas();
      }
      
      window.updateBgPos = function(source) {
          if(!bgLayer.img) return;
          if(source === 'input') {
              bgLayer.x = parseFloat(document.getElementById('bgX').value); 
              bgLayer.y = parseFloat(document.getElementById('bgY').value);
          } else {
              bgLayer.x = parseFloat(document.getElementById('bgXSlider').value);
              bgLayer.y = parseFloat(document.getElementById('bgYSlider').value);
          }
          updateBgUI(); drawCanvas();
      }

      window.updateBgLock = function() { bgLayer.locked = document.getElementById('bgLock').checked; }
      window.toggleScaleSlider = function() {
          const isRatioLocked = document.getElementById('bgRatio').checked;
          const sliderArea = document.getElementById('scaleSliderArea');
          if(isRatioLocked && bgLayer.img) {
              sliderArea.style.display = 'block';
              const currentPercent = Math.round((bgLayer.w / canvas.width) * 100);
              document.getElementById('bgScaleSlider').value = currentPercent;
              document.getElementById('scaleValue').innerText = currentPercent + '%';
          } else { sliderArea.style.display = 'none'; }
      }

      function drawCanvas(isExporting = false) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (bgLayer.img) { ctx.drawImage(bgLayer.img, bgLayer.x, bgLayer.y, bgLayer.w, bgLayer.h); } 
        else { if(!isExporting) drawPlaceholderLines(); else { ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width,canvas.height); } }

        if (document.getElementById('checkGradient').checked) {
            const intensity = document.getElementById('gradIntensity').value / 100;
            const gradient = ctx.createLinearGradient(0, canvas.height * 0.4, 0, canvas.height);
            gradient.addColorStop(0, "rgba(0,0,0,0)"); gradient.addColorStop(1, `rgba(0,0,0,${intensity})`);
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        textLayers.forEach(layer => {
            const x = (canvas.width * layer.posX) / 100; const y = (canvas.height * layer.posY) / 100;
            const fontStyle = layer.isItalic ? 'italic' : ''; const fontWeight = layer.isBold ? 'bold' : 'normal';
            ctx.font = `${fontStyle} ${fontWeight} ${layer.fontSize}px "${layer.fontFamily}"`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            
            if (layer.useBg) {
                const metrics = ctx.measureText(layer.text);
                const textWidth = metrics.width;
                const boxHeight = layer.fontSize + (layer.bgPadding * 2);
                const boxWidth = textWidth + (layer.bgPadding * 2) + 20; 
                ctx.save(); ctx.beginPath();
                ctx.roundRect(x - boxWidth / 2, y - boxHeight / 2, boxWidth, boxHeight, layer.bgRadius);
                ctx.fillStyle = layer.bgColor; ctx.fill();
                if (layer.bgBorderWidth > 0) { ctx.lineWidth = layer.bgBorderWidth; ctx.strokeStyle = layer.bgBorderColor; ctx.stroke(); }
                ctx.restore();
            }

            ctx.lineJoin = 'round';
            if (layer.useStroke) { ctx.lineWidth = layer.strokeWidth; ctx.strokeStyle = layer.strokeColor; ctx.strokeText(layer.text, x, y); }
            if (layer.shadow) { ctx.shadowColor = "rgba(0,0,0,0.6)"; ctx.shadowBlur = 15; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5; }
            ctx.fillStyle = layer.color; ctx.fillText(layer.text, x, y);
            ctx.shadowColor = "transparent"; ctx.shadowBlur = 0; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
            if (layer.isUnderline) {
                const metrics = ctx.measureText(layer.text);
                const width = metrics.width; const lineY = y + layer.fontSize * 0.55; 
                ctx.beginPath(); ctx.strokeStyle = layer.color; ctx.lineWidth = layer.fontSize * 0.08; 
                ctx.moveTo(x - width/2, lineY); ctx.lineTo(x + width/2, lineY); ctx.stroke();
            }
        });

        if (document.getElementById('checkBorder').checked) {
            const borderWidth = parseInt(document.getElementById('borderWidth').value);
            const borderRadius = parseInt(document.getElementById('borderRadius').value);
            const borderColor = document.getElementById('borderColor').value;
            ctx.strokeStyle = borderColor; ctx.lineWidth = borderWidth;
            const halfW = borderWidth / 2;
            ctx.beginPath(); ctx.roundRect(halfW, halfW, canvas.width - borderWidth, canvas.height - borderWidth, borderRadius); ctx.stroke();
        }

        const r = 30; 
        if (document.getElementById('checkSafeZone').checked && !isExporting) {
            ctx.fillStyle = "#000000"; 
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(r, 0); ctx.arcTo(0, 0, 0, r, r); ctx.lineTo(0, 0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(canvas.width, 0); ctx.lineTo(canvas.width-r, 0); ctx.arcTo(canvas.width, 0, canvas.width, r, r); ctx.lineTo(canvas.width, 0); ctx.fill();
            ctx.beginPath(); ctx.moveTo(canvas.width, canvas.height); ctx.lineTo(canvas.width-r, canvas.height); ctx.arcTo(canvas.width, canvas.height, canvas.width, canvas.height-r, r); ctx.lineTo(canvas.width, canvas.height); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, canvas.height); ctx.lineTo(r, canvas.height); ctx.arcTo(0, canvas.height, 0, canvas.height-r, r); ctx.lineTo(0, canvas.height); ctx.fill();
        }

        if (!isExporting) { drawGuides(); drawTimestamp(); }
      }

      function setupCanvasEvents() {
        canvas.addEventListener('mousedown', (e) => { e.preventDefault(); startInput(getMousePos(e)); });
        canvas.addEventListener('mousemove', (e) => { 
            const pos = getMousePos(e);
            if(isDragging) { e.preventDefault(); moveInput(pos); } else updateCursor(pos);
        });
        canvas.addEventListener('mouseup', endInput); canvas.addEventListener('mouseout', endInput);
        canvas.addEventListener('touchstart', (e) => {
            const pos = getTouchPos(canvas, e);
            if(isHitText(pos) || (!bgLayer.locked && bgLayer.img)) { if(e.cancelable) e.preventDefault(); startInput(pos); }
        }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { if(isDragging) { if(e.cancelable) e.preventDefault(); moveInput(getTouchPos(canvas, e)); } }, {passive: false});
        canvas.addEventListener('touchend', endInput);
      }

      function startInput(pos) {
          for (let i = textLayers.length - 1; i >= 0; i--) {
              if (isHitTextLayer(textLayers[i], pos)) {
                  isDragging = true; dragTarget = 'text'; dragIndex = i; 
                  if(document.getElementById('section-text').classList.contains('collapsed')) { jumpToSection('section-text', document.querySelectorAll('.quick-btn')[3]); }
                  return; 
              }
          }
          if(bgLayer.img && !bgLayer.locked) { isDragging = true; dragTarget = 'bg'; startX = pos.x; startY = pos.y; startBgX = bgLayer.x; startBgY = bgLayer.y; }
      }

      function moveInput(pos) {
          if (dragTarget === 'text') {
              const layer = textLayers[dragIndex];
              let tempX = (pos.x / canvas.width) * 100; let tempY = (pos.y / canvas.height) * 100;
              tempX = Math.max(0, Math.min(100, tempX)); tempY = Math.max(0, Math.min(100, tempY));
              layer.posX = snapToGrid(tempX, activeGrid); layer.posY = snapToGrid(tempY, activeGrid);
              drawCanvas(); 
          } else if (dragTarget === 'bg') {
              bgLayer.x = startBgX + (pos.x - startX); bgLayer.y = startBgY + (pos.y - startY);
              updateBgUI(); drawCanvas();
          }
      }

      function endInput() { if(isDragging) { isDragging = false; dragTarget = null; dragIndex = -1; renderTextLayersUI(); } }
      function isHitText(pos) { for (let i = textLayers.length - 1; i >= 0; i--) { if (isHitTextLayer(textLayers[i], pos)) return true; } return false; }
      function isHitTextLayer(layer, pos) {
          const x = (canvas.width * layer.posX) / 100; const y = (canvas.height * layer.posY) / 100;
          const padding = layer.useBg ? layer.bgPadding + 20 : 15;
          ctx.font = `${layer.isItalic?'italic':''} ${layer.isBold?'bold':'normal'} ${layer.fontSize}px "${layer.fontFamily}"`;
          const metrics = ctx.measureText(layer.text);
          return (pos.x >= x - metrics.width/2 - padding && pos.x <= x + metrics.width/2 + padding && pos.y >= y - layer.fontSize/2 - padding && pos.y <= y + layer.fontSize/2 + padding);
      }
      function updateCursor(pos) {
          let hit = false; for (let i = textLayers.length - 1; i >= 0; i--) { if (isHitTextLayer(textLayers[i], pos)) { hit = true; break; } }
          if(!hit && bgLayer.img && !bgLayer.locked) { canvas.style.cursor = 'all-scroll'; } else { canvas.style.cursor = hit ? 'move' : 'default'; }
      }
      function getMousePos(evt) { const rect = canvas.getBoundingClientRect(); return { x: (evt.clientX - rect.left) * (canvas.width / rect.width), y: (evt.clientY - rect.top) * (canvas.height / rect.height) }; }
      function getTouchPos(canvasDom, touchEvent) { var rect = canvasDom.getBoundingClientRect(); var touch = touchEvent.touches[0] || touchEvent.changedTouches[0]; return { x: (touch.clientX - rect.left) * (canvasDom.width / rect.width), y: (touch.clientY - rect.top) * (canvasDom.height / rect.height) }; }

      function drawPlaceholderLines() {
        ctx.fillStyle = "#181818"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#222"; ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }
        if(!bgLayer.img) { ctx.font = "bold 40px 'Segoe UI', sans-serif"; ctx.fillStyle = "#555"; ctx.textAlign = "center"; ctx.fillText("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”", canvas.width/2, canvas.height/2); }
      }

      function drawGuides() {
          let showCenterX = false; let showCenterY = false;
          textLayers.forEach(layer => { if (Math.abs(layer.posX - 50) < 0.5) showCenterX = true; if (Math.abs(layer.posY - 50) < 0.5) showCenterY = true; });
          if (showCenterX || showCenterY) {
              ctx.setLineDash([10, 5]); ctx.lineWidth = 2; ctx.strokeStyle = "#00FFEA"; ctx.beginPath();
              if (showCenterX) { ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); }
              if (showCenterY) { ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); }
              ctx.stroke(); ctx.setLineDash([]);
          }
          if (activeGrid > 0) {
              const segments = activeGrid; const stepX = canvas.width / segments; const stepY = canvas.height / segments;
              ctx.strokeStyle = "#FFFF00"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.beginPath();
              for (let i = 1; i < segments; i++) { ctx.moveTo(stepX * i, 0); ctx.lineTo(stepX * i, canvas.height); ctx.moveTo(0, stepY * i); ctx.lineTo(canvas.width, stepY * i); }
              ctx.stroke(); ctx.setLineDash([]);
          }
      }

      function drawTimestamp() {
          if (document.getElementById('checkSafeZone').checked) {
              const hasMusic = document.getElementById('checkMusicIcon').checked;
              const timeText = "4:05";
              ctx.font = "bold 20px Roboto, Arial, sans-serif"; 
              const musicIcon = "ğŸµ";
              const textMetrics = ctx.measureText(timeText);
              let musicMetrics = { width: 0 };
              if (hasMusic) { ctx.font = "20px Arial"; musicMetrics = ctx.measureText(musicIcon); ctx.font = "bold 20px Roboto, Arial, sans-serif"; }
              const paddingX = 8; const iconGap = hasMusic ? 5 : 0;
              const contentWidth = textMetrics.width + (hasMusic ? musicMetrics.width + iconGap : 0);
              const boxWidth = contentWidth + (paddingX * 2); const boxHeight = 36; 
              const boxX = canvas.width - boxWidth - 8; const boxY = canvas.height - boxHeight - 8;
              ctx.fillStyle = "rgba(0, 0, 0, 0.85)"; ctx.beginPath(); ctx.roundRect(boxX, boxY, boxWidth, boxHeight, 6); ctx.fill();
              ctx.fillStyle = "#ffffff"; ctx.textAlign = "left"; ctx.textBaseline = "middle";
              let currentX = boxX + paddingX; const centerY = boxY + boxHeight/2 + 1; 
              if (hasMusic) { ctx.font = "20px Arial"; ctx.fillText(musicIcon, currentX, centerY); currentX += musicMetrics.width + iconGap; }
              ctx.font = "bold 20px Roboto, Arial, sans-serif"; ctx.fillText(timeText, currentX, centerY);
          }
      }

      function makeSingleFile(input) {
          if(!input.files || !input.files[0]) return;
          const reader = new FileReader();
          reader.onload = function(e) {
              const base64Img = e.target.result; document.querySelector('.qr-img').src = base64Img;
              document.getElementById('qrWrapper').style.display = 'inline-block'; document.getElementById('qr-error').style.display = 'none';
              const adminSection = document.getElementById('owner-tools'); adminSection.parentNode.removeChild(adminSection);
              const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
              const blob = new Blob([htmlContent], {type: 'text/html'});
              const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ë”¸ê¹_ì¸ë„¤ì¼_ë©”ì´ì»¤.html'; a.click();
              alert("âœ… ë°°í¬ìš© íŒŒì¼(ë”¸ê¹_ì¸ë„¤ì¼_ë©”ì´ì»¤.html)ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"); setTimeout(() => location.reload(), 1000);
          }
          reader.readAsDataURL(input.files[0]);
      }

      async function handleFontUpload(input) {
        if (!input.files || input.files.length === 0) return;
        const file = input.files[0]; const fontName = file.name.split('.')[0]; 
        try {
            const arrayBuffer = await file.arrayBuffer(); const fontFace = new FontFace(fontName, arrayBuffer); await fontFace.load();
            document.fonts.add(fontFace); 
            if(!availableFonts.find(f => f.value === fontName)) { availableFonts.push({ name: `ğŸ“‚ ${fontName}`, value: fontName }); }
            renderTextLayersUI(); 
            if(textLayers.length > 0) { textLayers[textLayers.length - 1].fontFamily = fontName; renderTextLayersUI(); drawCanvas(); }
            alert(`í°íŠ¸ '${fontName}' ë¡œë“œ ì™„ë£Œ!`);
        } catch (e) { alert('í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨.'); }
        input.value = ''; 
      }

      function addManualFont() {
          const input = document.getElementById('manualFontInput'); const fontName = input.value.trim(); if(!fontName) return;
          if(!availableFonts.find(f => f.value === fontName)) { availableFonts.push({ name: `ğŸ’» ${fontName}`, value: fontName }); }
          renderTextLayersUI();
          if(textLayers.length > 0) { textLayers[textLayers.length - 1].fontFamily = fontName; renderTextLayersUI(); drawCanvas(); }
          input.value = '';
      }

      function getFontOptionsHTML(selectedFont) { return availableFonts.map(font => `<option value="${font.value}" ${font.value === selectedFont ? 'selected' : ''}>${font.name}</option>`).join(''); }
      
      function saveCustomColor(inputId) {
          const color = document.getElementById(inputId).value;
          customColors.unshift(color);
          if (customColors.length > 5) customColors.pop();
          renderTextLayersUI(); drawCanvas();
      }

      function createPaletteUI(containerId, inputId) {
        const container = document.getElementById(containerId); container.innerHTML = '';
        colorPresets.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; swatch.onclick = () => { document.getElementById(inputId).value = color; drawCanvas(); }; container.appendChild(swatch); });
      }
      
      function createTextPaletteHTML(layerIndex, targetProp, currentColor, inputId) {
        let html = '<div class="color-palette">';
        colorPresets.forEach(color => { html += `<div class="color-swatch" style="background-color:${color};" onclick="updateLayer(${layerIndex}, '${targetProp}', {value: '${color}'})"></div>`; });
        html += '</div><div class="custom-palette-area"><div class="custom-label"><span>ë‚˜ë§Œì˜ ìƒ‰ (5ê°œ)</span></div><div class="color-palette">';
        customColors.forEach(color => { html += `<div class="color-swatch" style="background-color:${color};" onclick="updateLayer(${layerIndex}, '${targetProp}', {value: '${color}'})"></div>`; });
        html += '</div></div>';
        
        // Add Input and Save Button
        html += `<div class="color-input-wrapper"><input type="color" id="${inputId}" value="${currentColor}" oninput="updateLayer(${layerIndex}, '${targetProp}', this)"><button class="btn btn-secondary btn-small" onclick="saveCustomColor('${inputId}')"><i class="fas fa-save"></i> ìƒ‰ ì €ì¥</button></div>`;
        return html;
      }

      function renderTextLayersUI() {
        const container = document.getElementById('textLayersContainer'); container.innerHTML = '';
        textLayers.forEach((layer, index) => {
          const div = document.createElement('div'); div.className = 'text-layer';
          const colorInputId = `textColorInput_${layer.id}`; const strokeColorInputId = `strokeColorInput_${layer.id}`;
          const bgColorInputId = `bgColorInput_${layer.id}`; const bgBorderColorInputId = `bgBorderColorInput_${layer.id}`;
          
          div.innerHTML = `
            <button class="remove-btn" onclick="removeLayer(${layer.id})"><i class="fas fa-times"></i></button>
            <label>ë‚´ìš©</label><input type="text" value="${layer.text}" oninput="updateLayer(${index}, 'text', this)">
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px; margin-bottom: 6px;">
               <div><label>ê¸€ê¼´</label><select onchange="updateLayer(${index}, 'fontFamily', this)">${getFontOptionsHTML(layer.fontFamily)}</select></div>
               <div><label>í¬ê¸°</label><input type="number" value="${layer.fontSize}" oninput="updateLayer(${index}, 'fontSize', this)"></div>
            </div>
            <label>ìŠ¤íƒ€ì¼</label><div class="style-group">
                <button class="style-btn ${layer.isBold ? 'active' : ''}" onclick="toggleStyle(${index}, 'isBold')"><i class="fas fa-bold"></i></button>
                <button class="style-btn ${layer.isItalic ? 'active' : ''}" onclick="toggleStyle(${index}, 'isItalic')"><i class="fas fa-italic"></i></button>
                <button class="style-btn ${layer.isUnderline ? 'active' : ''}" onclick="toggleStyle(${index}, 'isUnderline')"><i class="fas fa-underline"></i></button>
            </div>
            
            <label>í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
            ${createTextPaletteHTML(index, 'color', layer.color, colorInputId)}
            
            <div style="margin-top: 15px; border-top: 1px dashed #555; padding-top: 10px;">
                <div class="toggle-row"><span class="toggle-label"><i class="fas fa-pen-fancy"></i> ê¸€ì ì™¸ê³½ì„ </span><input type="checkbox" ${layer.useStroke ? 'checked' : ''} onchange="updateLayer(${index}, 'useStroke', {value: this.checked})"></div>
                ${layer.useStroke ? `<div class="sub-option-box"><label>ë‘ê»˜</label><input type="range" min="0" max="40" value="${layer.strokeWidth}" oninput="updateLayer(${index}, 'strokeWidth', this)"><label>ìƒ‰ìƒ</label>${createTextPaletteHTML(index, 'strokeColor', layer.strokeColor, strokeColorInputId)}</div>` : ''}
            </div>
            
            <div style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px;">
                <div class="toggle-row"><span class="toggle-label" style="color:#FFD700;"><i class="fas fa-square"></i> ë°°ê²½ ë°•ìŠ¤</span><input type="checkbox" ${layer.useBg ? 'checked' : ''} onchange="updateLayer(${index}, 'useBg', {value: this.checked})"></div>
                ${layer.useBg ? `<div class="sub-option-box">
                    <label>ë°°ê²½ ìƒ‰ìƒ</label>
                    ${createTextPaletteHTML(index, 'bgColor', layer.bgColor, bgColorInputId)}
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:5px;">
                        <div><label>ì—¬ë°±</label><input type="number" value="${layer.bgPadding}" oninput="updateLayer(${index}, 'bgPadding', this)"></div>
                        <div><label>ë‘¥ê¸€ê¸°</label><input type="number" value="${layer.bgRadius}" oninput="updateLayer(${index}, 'bgRadius', this)"></div>
                    </div>
                    <label style="margin-top:5px;">ë°°ê²½ í…Œë‘ë¦¬</label><input type="range" min="0" max="20" value="${layer.bgBorderWidth}" oninput="updateLayer(${index}, 'bgBorderWidth', this)">
                    ${layer.bgBorderWidth > 0 ? `<label>í…Œë‘ë¦¬ ìƒ‰ìƒ</label>${createTextPaletteHTML(index, 'bgBorderColor', layer.bgBorderColor, bgBorderColorInputId)}` : ''}
                </div>` : ''}
            </div>
            <div style="margin-top:10px; opacity:0.6;"><label>ìœ„ì¹˜</label><input type="range" min="0" max="100" value="${layer.posX}" oninput="updateLayer(${index}, 'posX', this)"><input type="range" min="0" max="100" value="${layer.posY}" oninput="updateLayer(${index}, 'posY', this)"></div>`;
          container.appendChild(div);
        });
      }

      window.updateLayer = function(index, prop, element) {
          let val = element.value; if(element.type === 'checkbox') val = element.checked;
          if(typeof element === 'object' && element.value !== undefined && !element.tagName) { val = element.value; }
          
          // íŒ”ë ˆíŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ì…ë ¥ì°½ ê°’ë„ ë™ê¸°í™” (ì‹œê°ì  ì—…ë°ì´íŠ¸)
          if(arguments.length === 3 && typeof element === 'object' && element.value !== undefined && !element.nodeName) {
               // íŒ”ë ˆíŠ¸ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°
          }

          textLayers[index][prop] = val; 
          drawCanvas();
          
          // ë¦¬ë Œë”ë§ì´ í•„ìš”í•œ ì†ì„±ë“¤ (ìƒ‰ìƒì€ íŒ”ë ˆíŠ¸ ë™ê¸°í™”ë¥¼ ìœ„í•´ ë¦¬ë Œë”ë§í•˜ê±°ë‚˜, 
          // ê°„ë‹¨í•˜ê²ŒëŠ” input ê°’ë§Œ ë°”ê¿”ì¤„ ìˆ˜ ìˆì§€ë§Œ ì½”ë“œê°€ ë³µì¡í•´ì§€ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¦¬ë Œë”ë§)
          // ë‹¨, ìŠ¬ë¼ì´ë”ë‚˜ í…ìŠ¤íŠ¸ ì…ë ¥ ì¤‘ í¬ì»¤ìŠ¤ ìœ ì§€ë¥¼ ìœ„í•´ ì œì™¸í•  í•­ëª© ì§€ì •
          if(!['text','fontSize','strokeWidth','posX','posY','bgPadding','bgRadius','bgBorderWidth'].includes(prop)) { 
              renderTextLayersUI(); 
          }
      }

      function toggleStyle(index, key) { textLayers[index][key] = !textLayers[index][key]; renderTextLayersUI(); drawCanvas(); }
      function addTextLayer() {
        const lastFont = textLayers.length > 0 ? textLayers[textLayers.length-1].fontFamily : 'Impact';
        textLayers.push({ id: Date.now(), text: 'NEW TEXT', fontSize: 80, fontFamily: lastFont, color: '#FFD700', posX: 50, posY: 50, isBold: true, isItalic: false, isUnderline: false, useStroke: true, strokeColor: '#000000', strokeWidth: 10, useBg: false, bgColor: '#000000', bgPadding: 10, bgRadius: 10, bgBorderWidth: 0, bgBorderColor: '#ffffff', shadow: true });
        renderTextLayersUI(); 
        const sectionText = document.getElementById('section-text');
        if(sectionText.classList.contains('collapsed')) { jumpToSection('section-text', document.querySelectorAll('.quick-btn')[3]); }
        drawCanvas();
      }
      function removeLayer(id) { textLayers = textLayers.filter(layer => layer.id !== id); renderTextLayersUI(); drawCanvas(); }
      function toggleGrid(type) {
        const grid3 = document.getElementById('checkGrid3'); const grid6 = document.getElementById('checkGrid6');
        if (type === 3) { if (grid3.checked) { grid6.checked = false; activeGrid = 3; } else { activeGrid = 0; } } else if (type === 6) { if (grid6.checked) { grid3.checked = false; activeGrid = 6; } else { activeGrid = 0; } }
        drawCanvas();
      }
      function applyPreset(type) {
        let targetIndex = textLayers.length - 1; if(targetIndex < 0) return; const layer = textLayers[targetIndex];
        if (type === 'center-big') { layer.posX = 50; layer.posY = 50; layer.fontSize = 130; } 
        else if (type === 'left-hook') { layer.posX = 25; layer.posY = 35; layer.fontSize = 90; } 
        else if (type === 'split-contrast') { layer.posX = 25; layer.posY = 50; layer.fontSize = 80; } 
        else if (type === 'bottom-story') { layer.posX = 50; layer.posY = 85; layer.fontSize = 65; } 
        else if (type === 'corner-badge') { layer.posX = 15; layer.posY = 15; layer.fontSize = 60; } 
        else if (type === 'diagonal-dynamic') { layer.posX = 50; layer.posY = 50; layer.fontSize = 100; }
        renderTextLayersUI(); drawCanvas();
      }
      function snapToGrid(val, segments) {
         if (segments === 0) return val; const step = 100 / segments; let closest = -1; let minDiff = 100;
         for (let i = 1; i < segments; i++) { const line = i * step; const diff = Math.abs(val - line); if (diff < minDiff) { minDiff = diff; closest = line; } }
         const centerDiff = Math.abs(val - 50); if (centerDiff < minDiff) { minDiff = centerDiff; closest = 50; } if (minDiff < 2) return closest; return val;
      }
      function downloadImage() {
        drawCanvas(true); const btn = document.getElementById('saveBtn'); const originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìµœì í™” ì¤‘...';
        setTimeout(() => {
            let quality = 0.95; let dataURL = canvas.toDataURL('image/jpeg', quality); let sizeInBytes = (dataURL.length * 3) / 4; const targetMax = 1.9 * 1024 * 1024; 
            while (sizeInBytes > targetMax && quality > 0.5) { quality -= 0.05; dataURL = canvas.toDataURL('image/jpeg', quality); sizeInBytes = (dataURL.length * 3) / 4; }
            const link = document.createElement('a'); link.download = 'youtube_thumbnail_final.jpg'; link.href = dataURL; link.click(); btn.innerHTML = originalText; drawCanvas(false);
        }, 100);
      }
      init();
    </script>
  </body>
</html>
